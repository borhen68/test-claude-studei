'use client';

import { useState, useEffect, use } from 'react';
import { useRouter } from 'next/navigation';
import { motion } from 'framer-motion';
import {
  ChevronLeft, Save, Eye, Undo, Redo, Sparkles, Loader2
} from 'lucide-react';
import { Button } from '@/components/ui/button';

// Studio Components (will create these)
import { PageThumbnails } from '@/components/studio/PageThumbnails';
import { BookCanvas } from '@/components/studio/BookCanvas';
import { EditorToolbar } from '@/components/studio/EditorToolbar';
import { EditorHeader } from '@/components/studio/EditorHeader';
import { PreviewModal } from '@/components/studio/PreviewModal';

interface Photo {
  id: string;
  url: string;
  thumbnailUrl: string;
  caption?: string;
  orientation: 'portrait' | 'landscape' | 'square';
}

interface PageData {
  id: string;
  pageNumber: number;
  template: string;
  photos: Photo[];
  caption?: string;
}

interface Book {
  id: string;
  title: string;
  theme: string;
  pages: PageData[];
  allPhotos: Photo[];
}

export default function BookStudioPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const resolvedParams = use(params);
  const router = useRouter();
  
  const [book, setBook] = useState<Book | null>(null);
  const [loading, setLoading] = useState(true);
  const [currentPageIndex, setCurrentPageIndex] = useState(0);
  const [selectedPhoto, setSelectedPhoto] = useState<string | null>(null);
  const [isSaving, setIsSaving] = useState(false);
  const [showPreview, setShowPreview] = useState(false);
  const [history, setHistory] = useState<Book[]>([]);
  const [historyIndex, setHistoryIndex] = useState(-1);

  // Load book data
  useEffect(() => {
    const loadBook = async () => {
      try {
        const res = await fetch(`/api/books/${resolvedParams.id}`);
        const data = await res.json();
        
        if (data.success && data.book) {
          setBook(data.book);
          setHistory([data.book]);
          setHistoryIndex(0);
        }
      } catch (error) {
        console.error('Failed to load book:', error);
      } finally {
        setLoading(false);
      }
    };

    loadBook();
  }, [resolvedParams.id]);

  // Auto-save every 3 seconds if changed
  useEffect(() => {
    if (!book || historyIndex < 0) return;

    const timer = setTimeout(async () => {
      await saveBook();
    }, 3000);

    return () => clearTimeout(timer);
  }, [book, historyIndex]);

  const saveBook = async () => {
    if (!book) return;
    setIsSaving(true);

    try {
      const res = await fetch(`/api/books/${book.id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(book),
      });

      if (res.ok) {
        console.log('Book saved');
      }
    } catch (error) {
      console.error('Save failed:', error);
    } finally {
      setIsSaving(false);
    }
  };

  const updateBook = (updater: (book: Book) => Book) => {
    if (!book) return;

    const newBook = updater(book);
    setBook(newBook);
    
    // Add to history
    const newHistory = history.slice(0, historyIndex + 1);
    newHistory.push(newBook);
    setHistory(newHistory);
    setHistoryIndex(newHistory.length - 1);
  };

  const undo = () => {
    if (historyIndex > 0) {
      setHistoryIndex(historyIndex - 1);
      setBook(history[historyIndex - 1]);
    }
  };

  const redo = () => {
    if (historyIndex < history.length - 1) {
      setHistoryIndex(historyIndex + 1);
      setBook(history[historyIndex + 1]);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="h-12 w-12 animate-spin text-violet-500 mx-auto mb-4" />
          <p className="text-white text-lg">Loading your book studio...</p>
        </div>
      </div>
    );
  }

  if (!book) {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center">
        <div className="text-center">
          <p className="text-white text-xl mb-4">Book not found</p>
          <Button variant="primary" onClick={() => router.push('/dashboard')}>
            Go to Dashboard
          </Button>
        </div>
      </div>
    );
  }

  const currentPage = book.pages[currentPageIndex];

  return (
    <div className="h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex flex-col overflow-hidden">
      {/* Top Header */}
      <EditorHeader
        book={book}
        onTitleChange={(title) => updateBook(b => ({ ...b, title }))}
        onBack={() => router.push('/dashboard')}
        onPreview={() => setShowPreview(true)}
        onCheckout={() => router.push(`/checkout?bookId=${book.id}`)}
        isSaving={isSaving}
        canUndo={historyIndex > 0}
        canRedo={historyIndex < history.length - 1}
        onUndo={undo}
        onRedo={redo}
      />

      {/* Main Studio Layout */}
      <div className="flex-1 flex overflow-hidden">
        {/* Left Sidebar - Page Thumbnails */}
        <PageThumbnails
          pages={book.pages}
          currentIndex={currentPageIndex}
          onPageSelect={setCurrentPageIndex}
          onReorder={(fromIndex, toIndex) => {
            updateBook(b => {
              const newPages = [...b.pages];
              const [removed] = newPages.splice(fromIndex, 1);
              newPages.splice(toIndex, 0, removed);
              return { ...b, pages: newPages.map((p, i) => ({ ...p, pageNumber: i })) };
            });
          }}
          onAddPage={() => {
            updateBook(b => ({
              ...b,
              pages: [
                ...b.pages,
                {
                  id: `page-${Date.now()}`,
                  pageNumber: b.pages.length,
                  template: 'duo_horizontal',
                  photos: [],
                },
              ],
            }));
          }}
          onDeletePage={(index) => {
            if (book.pages.length > 1) {
              updateBook(b => ({
                ...b,
                pages: b.pages.filter((_, i) => i !== index).map((p, i) => ({ ...p, pageNumber: i })),
              }));
              if (currentPageIndex >= book.pages.length - 1) {
                setCurrentPageIndex(Math.max(0, currentPageIndex - 1));
              }
            }
          }}
        />

        {/* Center Canvas - Main Editing Area */}
        <BookCanvas
          page={currentPage}
          selectedPhotoId={selectedPhoto}
          onPhotoSelect={setSelectedPhoto}
          onPhotoUpdate={(photoId, updates) => {
            updateBook(b => ({
              ...b,
              pages: b.pages.map(p =>
                p.id === currentPage.id
                  ? {
                      ...p,
                      photos: p.photos.map(ph =>
                        ph.id === photoId ? { ...ph, ...updates } : ph
                      ),
                    }
                  : p
              ),
            }));
          }}
          onTemplateChange={(template) => {
            updateBook(b => ({
              ...b,
              pages: b.pages.map(p =>
                p.id === currentPage.id ? { ...p, template } : p
              ),
            }));
          }}
          onNavigate={(direction) => {
            if (direction === 'prev' && currentPageIndex > 0) {
              setCurrentPageIndex(currentPageIndex - 1);
            } else if (direction === 'next' && currentPageIndex < book.pages.length - 1) {
              setCurrentPageIndex(currentPageIndex + 1);
            }
          }}
        />

        {/* Right Sidebar - Tools */}
        <EditorToolbar
          selectedPhotoId={selectedPhoto}
          currentPage={currentPage}
          theme={book.theme}
          onThemeChange={(theme) => updateBook(b => ({ ...b, theme }))}
          onTemplateChange={(template) => {
            updateBook(b => ({
              ...b,
              pages: b.pages.map(p =>
                p.id === currentPage.id ? { ...p, template } : p
              ),
            }));
          }}
          onCaptionChange={(caption) => {
            if (selectedPhoto) {
              updateBook(b => ({
                ...b,
                pages: b.pages.map(p =>
                  p.id === currentPage.id
                    ? {
                        ...p,
                        photos: p.photos.map(ph =>
                          ph.id === selectedPhoto ? { ...ph, caption } : ph
                        ),
                      }
                    : p
                ),
              }));
            }
          }}
          onPhotoReplace={(newPhotoId) => {
            if (selectedPhoto) {
              // Implementation for replacing photo
              console.log('Replace photo:', selectedPhoto, 'with', newPhotoId);
            }
          }}
        />
      </div>

      {/* Preview Modal */}
      <PreviewModal
        isOpen={showPreview}
        book={book}
        onClose={() => setShowPreview(false)}
      />
    </div>
  );
}
